$(function() {

    $('.owl-carousel').owlCarousel({
        loop: true,
        items: 1,
        margin: 10,
        nav: true,

        autoplay: true,
        autoplayTimeout: 7000,
        autoplayHoverPause: true,

        navText: [
            '<img src="' + $('#banner').data('left') + '" alt="left">',
            '<img src="' + $('#banner').data('right') + '" alt="right">'
        ]
    });

    $("#menu-btn").click( function (event) {
        //event.preventDefault();

        $(this).children().next().slideToggle(300);
        $(this).find('p').toggleClass('tuggle_click');
    });

    $("nav .link").on('click', function (event) {
        event.preventDefault();
        var id  = $(this).attr('href');
        map = $(id).offset();
        $('body,html').animate({
            scrollTop: map.top
        }, 1000);
    });
    /**
     * Окно корзины
     */
    $("#basket .close, #overlay").click( function (event) {
        event.preventDefault();
        $("#basket").animate({opacity: 0, top: '45%'}, 200, function () {
            $(this).css("display", "none");
            $("#overlay").fadeOut(400);
        });
    });



    const setDisplayForFormFields = display => {
        $("#sent-request input[name='adres'], input[name='etag'], input[name='podezd'], input[name='kvartira'], #pay-variant-head, .castom-checkbox, #ifcash").css("display", display);

        let inputs = [
            $("#sent-request input[name='adres']"),
            $("#sent-request input[name='etag']"),
            $("#sent-request input[name='podezd']"),
            $("#sent-request input[name='cash']"),
            $("#sent-request input[name='manyback']"),
            $("#sent-request input[name='domophone']"),
            $("#sent-request input[name='kvartira']")
        ];

        let elem = $("#conf");
        if (display == "none") {
            elem.css("margin-top", "15px");
            inputs.forEach(input => input.attr('disabled', 'disabled'));
        } else if (display == "block") {
            elem.css("margin-top", "82px");
            inputs.forEach(input => input.attr('disabled', false));
        }
    }

    /**
     * Активация/Деактивация кнопки "Продолжить"
     */

    $("#basket").on("change", "#delivery-checkbox", (event) => {
        if (event.target.checked) {
            $(".red_button").removeClass("red_button-deactive");
        } else {
            let price = parseInt($("#total_price").text());
            if (price <= 800) {
                $(".red_button").addClass("red_button-deactive");
            }
        }
    });

    /**
     * Модальное окно
     * Оформление заказа
     */
    $("#basket").on("click", ".red_button", function (event) {
        event.preventDefault();


        // если чекбокс 1 то да то нетм
        let checkbox = $("#delivery-checkbox")[0].checked;
        let withDelivery = $("#sent-request").children("input[name='delivery']");

        if (checkbox) {
            setDisplayForFormFields("none");
            withDelivery.val(1);
        } else {
            setDisplayForFormFields("block");
            withDelivery.val(0);
        }

        let isPriceValid = !event.target.className.includes("red_button-deactive");
        if (isPriceValid) {
            $("#sent-request").children("input[type='submit']").val('Отправить');
            $("#basket").animate({opacity: 0, top: '45%'}, 200, function () {
                $(this).css("display", "none");
            });
            $("#border1").animate({opacity: 1, top: '50%'}, 200, function () {
                $(this).css("display", "block");
            });
        }
    });

    $("#border1 .close, #overlay").click((event) => {
        event.preventDefault();
        $("#border1").animate({opacity: 0, top: '45%'}, 200, function () {
            $(this).css("display", "none");
            $("#overlay").fadeOut(400);
        });
    });


    $("#border1 input[name='cash']").change(function() {
        if (this.value == 'cash') {
            $("#ifcash").css('display', 'block');
        } else if (this.value == 'card') {
            $("#ifcash").css('display', 'none');
        }
    });

    $("#basket").on("change", "#delivery-checkbox", () => {
        console.log();
    });

    /**
     * Отправка формы.
     */
    $("#sent-request").submit( function(event) {
        event.preventDefault();
        $(this).children("input[type='submit']").val('Ожидайте звонка');
        form = this;
        $.ajax({
            url: $(form).attr("action"),
            type: "POST",
            data: new FormData(this),
            cache: false,
            contentType: false,
            processData: false,
            success: (response) => {
                console.log(response);
                $("#count span").text(0);

            },
            error: error => console.log(error)
        }).done( function() {
            if (form) {
                form.reset();
            }
            $("#border1").animate({opacity: 0, top: '45%'}, 100, function () {
                $(this).css("display", "none");
                $("#overlay").fadeOut(100);
            });
        });
    });


    /**
     * Добавление в товара в корзину
     */
    // if (localStorage.getItem('tottal_count')) {
    //     $("#count span").text(localStorage.getItem('tottal_count'));
    // } else {
    //     $("#count span").text(0);
    // }
    $("#content").on("click", ".basket", function() {
        var 
            category = $(this).data('category'),
            id = $(this).data('id'),
            name = $(this).data('name'),
            description = $(this).data('description'),
            price = $(this).data('price'),
            size = $(this).data('size'),
            unit = $(this).data('unit'),
            url = $(this).data('url');

        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            data: {
                category: category,
                id: id,
                name: name,
                description: description,
                price: price,
                size: size,
                unit: unit
            },
            success: function (result) {
                $("#count span").text(result);
                // localStorage.setItem('tottal_count', result);
            },
            error: error => console.log(error)
        });
    });
    
    /**
     * Открытие окна корзины
     */
    $("#fixed-basket").click(function (event) {
        event.preventDefault();
        $("#overlay").fadeIn(400, function () {
            $("#basket").css("display", "block").animate({opacity: 1, top: '50%'}, 200);
        });
        var url = $(this).data('url');
        $.ajax({
            url: url,
            type: 'POST',
            dataType: 'html',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            success: function (result) {
                $("#ordered_goods").html(result);
            },
            error: error => console.log(error)
        });
    });

    /**
     * Количество товаров в строке корзины
     * Минус
     */
    $("#basket #buy #block").on('click', '.minus', function (event) {
        event.preventDefault();

        var
            url = $(this).data('url')
            // cnt = $("#count span").text();

        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            // success: function (result) {

            //     if (cnt == 0) {
            //         cnt = 0;
            //     } else {
            //         cnt--;
            //     }
                
            //     $("#count span").text(cnt);
            //     $("#ordered_goods").html(result);
            //     console.log(result);
            // },
            success: function (result) {
                $("#ordered_goods").html(result);
                var count = $("#cart_count").val();
                $("#count span").text(count);
            },
            error: function () {
                console.log('ошибка');
            }
        });
    });

    /**
     * Количество товаров в строке корзины
     * Плюс
     */
    $("#basket #buy #block").on('click', '.plus', function (event) {
        event.preventDefault();
        var
            url = $(this).data('url')
            // cnt = $("#count span").text();

        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            success: function (result) {
                // cnt++;
                // $("#count span").text(cnt);
                // $("#ordered_goods").html(result);
                $("#ordered_goods").html(result);
                var count = $("#cart_count").val();
                $("#count span").text(count);
            },
            error: function () {
                console.log('ошибка');
            }
        });
    });

    /**
     * Переключение категорий ajax'ом
     */
    $(".ajax-link").click(function (event) {
        event.preventDefault();
        var link = $(this).data("href");
        var link_2 = $(this).attr('href');
        $.ajax({
            url: link,
            type: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            success: function (result) {
                $("#content").html(result);
                setLocation(link_2);
            },
            error: function () {
                console.log('ошибка');
            },
            // success: function (result) {
            //     $("count").html(result);
            //     setLocation(link_2);
            // },
           
        });
    });

    function setLocation(curLoc){
        try {
            history.pushState(null, null, curLoc);
            return;
        } catch(e) {}
        location.hash = curLoc;
    };

    /**
     * очищение счетчика корзины через 30 мин
     */
     
 //   setTimeout(function() { // через 30 мин - отмена setInterval
	// localStorage.setItem('count', 0);
	// $("content").html(0);
	// }, 1000 * 60 * 30);
	
    //очищаем все хранилище
    // localStorage.clear();

});
